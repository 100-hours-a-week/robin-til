# AWSì •ë¦¬

## AWS

### EC2 :  AWSì—ì„œ ì œê³µí•˜ëŠ” ì›ê²© ì„œë²„

- ì˜¤í†  ìŠ¤ì¼€ì¼ë§ ê·¸ë£¹
    - ì‚¬ìš©ìì˜ ìš”ì²­ íšŸìˆ˜ì— ë”°ë¼ EC2ë¥¼ ëŠ˜ì´ê±°ë‚˜ ì¤„ì…ë‹ˆë‹¤.
- ë¡œë“œ ë°¸ëŸ°ì„œ
    - ìš”ì²­ì„ ì–´ë””ë¡œ ë¶„ì‚°ì‹œí‚¬ì§€ ê·¸ë£¹ì„ ì •í•œë‹¤. ì´ ê·¸ë£¹ì„ ëŒ€ìƒ ê·¸ë£¹ì´ë¼ê³  ë¶€ë¦„
- ë°ì´í„° ì €ì¥ì†Œ RDS
    - ë°ì´í„°ë² ì´ìŠ¤ë„ í´ë¼ìš°ë“œì— ì˜¬ë ¤ì•¼í•¨

## ì¼ë˜ìŠ¤í‹± ë¹ˆìŠ¤í† í¬

1. ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±
2. ë²„ì „ ì—…ë¡œë“œ
3. í™˜ê²½ ìƒì„±
4. í™˜ê²½ ê´€ë¦¬

```java
name: Deploy to EC2
//ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì…ë‹ˆë‹¤.
on:
  push:
    branches:
      - main
//main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
jobs:
  build:
//ì´ ì›Œí¬í”Œë¡œìš°ì—ëŠ” buildë¼ëŠ” ì‘ì—…ì´ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    runs-on: ubuntu-latest //ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ì€ ìµœì‹  ë²„ì „ì˜ Ubuntuì…ë‹ˆë‹¤.
    permissions: //ì´ ì„¹ì…˜ì€ GitHub Actionsì˜ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
      contents: read
      packages: write

    steps: //ì‘ì—…ì—ì„œ ìˆ˜í–‰í•  ë‹¨ê³„ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4 //ì½”ë“œ ì €ì¥ì†Œë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
      with:
        java-version: '17'
        distribution: 'temurin'
        server-id: github
        settings-path: ${{ github.workspace }}
//Java 17 í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
//Gradleì„ ì„¤ì •í•©ë‹ˆë‹¤.
    - name: Build with Gradle
      run: ./gradlew build
//Gradleì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•©ë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ë¹Œë“œëœ .jar íŒŒì¼ì´ build/libs/ ë””ë ‰í† ë¦¬ì— ìƒì„±ë©ë‹ˆë‹¤.
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.AWS_EC2_KEY }}
//SSH ì—°ê²°ì„ ì„¤ì •í•©ë‹ˆë‹¤. AWS_EC2_KEYëŠ” GitHub Secretsì— ì €ì¥ëœ EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í”„ë¼ì´ë¹— í‚¤ì…ë‹ˆë‹¤.
    - name: Copy files to EC2
      run: |
        scp -o StrictHostKeyChecking=no -r * ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:/home/${{ secrets.AWS_EC2_USER }}/app
//ë¹Œë“œëœ íŒŒì¼ì„ EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤. ëª¨ë“  íŒŒì¼ì„ /home/${{ secrets.AWS_EC2_USER }}/app ë””ë ‰í† ë¦¬ì— ë³µì‚¬í•©ë‹ˆë‹¤.
    - name: Deploy on EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          cd /home/${{ secrets.AWS_EC2_USER }}/app
          # í•„ìš”í•œ ë°°í¬ ëª…ë ¹ì–´ ì‹¤í–‰
          ./deploy.sh
        EOF
//EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•˜ì—¬ /home/${{ secrets.AWS_EC2_USER }}/app ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•œ í›„, deploy.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°°í¬ ê´€ë ¨ ëª…ë ¹ì–´ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
```

## í™˜ê²½ë³€ìˆ˜ ì„¤ì •

```java
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: ${SPRING_DATASOURCE_URL}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}
```

sudo vim /etc/environment 

```java
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
SPRING_DATASOURCE_URL=jdbc:mysql://robin-rds.cxkycgaayc77.ap-northeast-2.rds.amazonaws.com:3306/community
SPRING_DATASOURCE_USERNAME=admin
SPRING_DATASOURCE_PASSWORD=yourpassword  # ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ë¡œ ëŒ€ì²´
```

source /etc/environment

## rdsì—°ë™ í›„ ec2ì—ì„œ mysql ì ‘ì†

```java
mysql -h robin-rds.cxkycgaayc77.ap-northeast-2.rds.amazonaws.com -u admin -p
```

ì—”ë“œí¬ì¸íŠ¸ ì°ì–´ì£¼ê¸°

## urlì ‘ì† ì•ˆë˜ëŠ” ë¬¸ì œ

<aside>
ğŸ’¡ httpsë¡œ ë“¤ì–´ê°€ë©´ ì—°ê²° ê±°ë¶€ httpë¡œ ë“¤ì–´ê°€ë©´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ëœë‹¤.

</aside>

[http://ec2-3-38-115-218.ap-northeast-2.compute.amazonaws.com/](http://ec2-3-38-115-218.ap-northeast-2.compute.amazonaws.com/)

## ìŠ¤í”„ë§ ë¶€íŠ¸ í¬íŠ¸ ë³€ê²½

```java
# ì„œë²„ í¬íŠ¸ ì„¤ì •
server:
  port: 9090
```

.ymlì— ì¶”ê°€

## ìŠ¤í”„ë§ ì‹¤í–‰

```java
java -jar myapp.jar
```

ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰

```java
nohup java -jar myapp.jar > myapp.log 2>&1 &
```

# í´ë¼ì´ì–¸íŠ¸ ë°°í¬

## nginxíŒŒì¼

```java
sudo vim /etc/nginx/sites-available/default
```

## nginxì„¤ì •

```java
upstream tomcat { //ì´ ë¸”ë¡ì€ Nginxê°€ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¡œ ì‚¬ìš©í•  ë°±ì—”ë“œ ì„œë²„(ì´ ê²½ìš° Tomcat)ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
        ip_hash; //í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­ì„ ë¶„ë°°í•©ë‹ˆë‹¤.
        server 127.0.0.1:8080 max_fails=5 fail_timeout=3s;
        //Tomcat ì„œë²„ì˜ ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        keepalive 300;
}

server { //ì´ ë¸”ë¡ì€ Nginxê°€ ìˆ˜ì‹ í•  í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì •ì˜í•©ë‹ˆë‹¤.
        listen 80 default_server;
        // IPv4ì—ì„œ ê¸°ë³¸ ì„œë²„ë¡œ í¬íŠ¸ 80ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
        listen [::]:80 default_server;
        // IPv6ì—ì„œ ê¸°ë³¸ ì„œë²„ë¡œ í¬íŠ¸ 80ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤.

        root /app/tomcat/webapps/ROOT;
        //ì •ì  íŒŒì¼ì˜ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        index index.jsp;
				//ê¸°ë³¸ ì¸ë±ìŠ¤ íŒŒì¼ì„ ì§€ì •í•©ë‹ˆë‹¤.
        server_name _;
				
        charset utf-8;
        location / {
        //ì´ ë¸”ë¡ì€ ë£¨íŠ¸ URLì— ëŒ€í•œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ë©°, proxy_pass ì§€ì‹œë¬¸ì„ ì‚¬ìš©í•˜ì—¬ Tomcat ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
                proxy_pass http://tomcat/;
        }
}
```

í”„ë¡ íŠ¸ì½”ë“œ ì—…ë¡œë“œ

```java
scp -i ~/.ssh/robin-ssh-key.pem -r /Users/taeungjeon/Desktop/spring-fe-awsrds/* ubuntu@ec2-3-38-115-218.ap-northeast-2.compute.amazonaws.com:/home/ubuntu/node-app/
```

ìš©ëŸ‰í™•ì¸

```java
du -sh /home/ubuntu/node-app
```

nginx ìˆ˜ì •

```java
upstream backend {
    ip_hash;
    server 127.0.0.1:9090 max_fails=5 fail_timeout=3s;
    keepalive 300;
}

upstream frontend {
    ip_hash;
    server 127.0.0.1:8081 max_fails=5 fail_timeout=3s;
    keepalive 300;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    charset utf-8;

    location / {
        proxy_pass http://frontend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /home/ubuntu/node-app/public/;
    }
}

```

```java
sudo nginx -t
sudo systemctl restart nginx
```

nodejs, npm ì„¤ì¹˜

```java
sudo apt update
sudo apt install nodejs
sudo apt install npm
```

í™•ì¸í›„

```java
node -v
npm -v
```

í”„ë¡ íŠ¸ê²½ë¡œì— npmì„¤ì¹˜

```java
cd /path/to/your/project
npm install
```

ë°±ê·¸ë¼ìš´ë“œì—ì„œ app.jsì‹¤í–‰

pm2, nohup ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆëŠ”ë° nohupë°©ë²•ì„ ì‚¬ìš©

 

```java
nohup node app.js > app.log 2>&1 &
```

.jarë„ ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰

```java
nohup java -jar your-spring-boot-application.jar > app.log 2>&1 &
```

ì‹¤í–‰ í™•ì¸

```java
ps -ef | grep java
ps -ef | grep node
```

í”„ë¡ íŠ¸ì— .envíŒŒì¼ì„ ì‚¬ìš©í–ˆë‹¤ë©´ dotenvì„¤ì¹˜

```java
npm install dotenv
```

ë°±ì—”ë“œ webconfigí™•ì¸í•´ì„œ CORSë°©ì§€í•œë‹¤.